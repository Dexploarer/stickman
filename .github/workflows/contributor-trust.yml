name: contributor-trust

on:
  pull_request_review:
    types:
      - submitted
  workflow_dispatch:

jobs:
  trust:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute trust snapshot from review event
        if: github.event_name == 'pull_request_review'
        run: |
          node .github/trust-scoring.cjs from-review-event \
            --event-file "$GITHUB_EVENT_PATH" \
            --state-file .github/contributor-trust.json \
            --output trust-result.json
          cat trust-result.json
          node - <<'NODE'
          const fs = require("node:fs");
          const d = JSON.parse(fs.readFileSync("trust-result.json", "utf8"));
          const lines = [
            "## Contributor Trust Snapshot",
            `- Contributor: \`${d.contributor}\``,
            `- Event: \`${d.event.type}\` on PR #${d.event.prNumber ?? "n/a"}`,
            `- Score: **${d.result.score}**`,
            `- Tier: **${d.result.tier}**`,
            `- Warnings: ${d.result.warnings.length ? d.result.warnings.join("; ") : "none"}`,
          ];
          fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, `${lines.join("\n")}\n`);
NODE

      - name: Print current trust summary
        if: github.event_name == 'workflow_dispatch'
        run: |
          node .github/trust-scoring.cjs summary \
            --state-file .github/contributor-trust.json \
            --output trust-summary.json
          cat trust-summary.json
